import React, { useRef } from 'react';
import Navigation from '../components/Navigation';
import VideoPreview from '../components/VideoPreview';
import ViralScores from '../components/ViralScores';
import RetentionHeatmap from '../components/RetentionHeatmap';
import ActionSuggestions from '../components/ActionSuggestions';
import Highlights from '../components/Highlights';
import { ArrowLeft, Download, Share2 } from 'lucide-react';

const Results = ({ results, videoFile, onBack, onLogin }) => {
    console.log('ðŸ“Š Results Page Received Data:', results);
    const videoRef = useRef(null);

    // Function to jump to a specific timestamp in the video
    const handlePlayHighlight = (timestamp) => {
        if (videoRef.current) {
            videoRef.current.currentTime = timestamp;
            videoRef.current.play();
            // Scroll to top to see video if needed
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    // Function to generate and download a text report
    const handleExport = () => {
        if (!results) return;

        const date = new Date().toLocaleDateString();
        const filename = videoFile ? videoFile.name : 'video_analysis';

        const reportContent = `
VIRAL PILOT ANALYSIS REPORT
===========================
Date: ${date}
File: ${filename}

ðŸ“Š DETAILED SCORES
------------------
â€¢ Hook: ${results.scores.hookScore}/100
â€¢ Pacing: ${results.scores.pacingScore}/100
â€¢ Emotion: ${results.scores.emotionScore}/100
â€¢ Storytelling: ${results.scores.storytellingScore}/100

ðŸ’¡ ACTIONABLE SUGGESTIONS
-------------------------
Hook Rewrite:
"${results.suggestedHookRewrite}"

CTA Rewrite:
"${results.suggestedCTARewrite}"

Editing Tips:
${results.suggestedEdits}

ðŸ”¥ TOP HIGHLIGHTS
-----------------
${results.bestHighlights.map((h, i) => `${i + 1}. ${h.description} (${h.start}s - ${h.end}s) - Score: ${h.score}`).join('\n')}

___________________________
Generated by ViralPilot
`;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ViralPilot_Report_${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // Function to share results
    const handleShare = async () => {
        if (!results) return;

        const shareData = {
            title: 'ViralPilot Analysis',
            text: `Check out my ViralPilot analysis! ðŸš€\nHook Score: ${results.scores.hookScore}/100\nAvg Score: ${Math.round((results.scores.hookScore + results.scores.pacingScore + results.scores.emotionScore + results.scores.storytellingScore) / 4)}/100`,
            url: window.location.href // Current URL (likely home, but useful for context)
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(shareData.text);
                alert('Results copied to clipboard!');
            }
        } catch (err) {
            console.error('Error sharing:', err);
        }
    };

    if (!results) return null;

    const videoUrl = videoFile ? URL.createObjectURL(videoFile) : null;

    return (
        <div className="min-h-screen bg-slate-50 relative pb-20">
            <Navigation onLogin={onLogin} />

            <main className="pt-24 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
                {/* Header */}
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <button
                        onClick={onBack}
                        className="flex items-center gap-2 text-gray-600 hover:text-brand-600 transition-colors font-medium"
                    >
                        <ArrowLeft className="w-5 h-5" />
                        Analyze Another Video
                    </button>

                    <div className="flex gap-3">
                        <button
                            onClick={handleShare}
                            className="btn btn-secondary gap-2"
                        >
                            <Share2 className="w-4 h-4" />
                            Share
                        </button>
                        <button
                            onClick={handleExport}
                            className="btn btn-primary gap-2"
                        >
                            <Download className="w-4 h-4" />
                            Export Report
                        </button>
                    </div>
                </div>

                <div className="grid lg:grid-cols-12 gap-8">
                    {/* Left Column - Video & Key Metrics */}
                    <div className="lg:col-span-4 space-y-8">
                        <div className="sticky top-24 space-y-8">
                            <div className="card p-1 bg-white shadow-xl">
                                <VideoPreview ref={videoRef} videoUrl={videoUrl} />
                            </div>

                            <ViralScores
                                scores={results.scores}
                                platformScores={results.platformScores}
                            />
                        </div>
                    </div>

                    {/* Right Column - Deep Analysis */}
                    <div className="lg:col-span-8 space-y-8">
                        <RetentionHeatmap data={results.retentionHeatmap} />

                        <div className="grid md:grid-cols-2 gap-8">
                            <div className="md:col-span-2">
                                <ActionSuggestions suggestions={results} />
                            </div>
                        </div>

                        <Highlights
                            highlights={results.bestHighlights}
                            onPlayHighlight={handlePlayHighlight}
                        />
                    </div>
                </div>
            </main>
        </div>
    );
};

export default Results;
